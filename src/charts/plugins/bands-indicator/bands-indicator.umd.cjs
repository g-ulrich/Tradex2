(function(l,u){typeof exports=="object"&&typeof module<"u"?u(exports):typeof define=="function"&&define.amd?define(["exports"],u):(l=typeof globalThis<"u"?globalThis:l||self,u(l.BandsIndicator={}))})(this,function(l){"use strict";var k=Object.defineProperty;var S=(l,u,d)=>u in l?k(l,u,{enumerable:!0,configurable:!0,writable:!0,value:d}):l[u]=d;var n=(l,u,d)=>(S(l,typeof u!="symbol"?u+"":u,d),d);function u(c){if(c===void 0)throw new Error("Value is undefined");return c}class d{constructor(){n(this,"_chart");n(this,"_series");n(this,"_requestUpdate");n(this,"_fireDataUpdated",t=>{this.dataUpdated&&this.dataUpdated(t)})}requestUpdate(){this._requestUpdate&&this._requestUpdate()}attached({chart:t,series:e,requestUpdate:s}){this._chart=t,this._series=e,this._series.subscribeDataChanged(this._fireDataUpdated),this._requestUpdate=s,this.requestUpdate()}detached(){var t;(t=this._series)==null||t.unsubscribeDataChanged(this._fireDataUpdated),this._chart=void 0,this._series=void 0,this._requestUpdate=void 0}get chart(){return u(this._chart)}get series(){return u(this._series)}}function x(c){return JSON.parse(JSON.stringify(c))}class m{constructor(t){n(this,"numbers");n(this,"cache");this.numbers=t,this.cache=new Map}findClosestIndex(t,e){const s=`${t}:${e}`;if(this.cache.has(s))return this.cache.get(s);const i=this._performSearch(t,e);return this.cache.set(s,i),i}_performSearch(t,e){let s=0,i=this.numbers.length-1;if(t<=this.numbers[0].time)return 0;if(t>=this.numbers[i].time)return i;for(;s<=i;){const r=Math.floor((s+i)/2),a=this.numbers[r].time;if(a===t)return r;a>t?i=r-1:s=r+1}return e==="left"?s:i}}class w{constructor(t,e=10){n(this,"_arr");n(this,"_chunkSize");n(this,"_cache");this._arr=t,this._chunkSize=e,this._cache=new Map}getMinMax(t,e){const s=`${t}:${e}`;if(s in this._cache)return this._cache.get(s);const i={lower:1/0,upper:-1/0},r=Math.floor(t/this._chunkSize),a=Math.floor(e/this._chunkSize);for(let h=r;h<=a;h++){const o=h*this._chunkSize,_=Math.min((h+1)*this._chunkSize-1,this._arr.length-1),I=`${o}:${_}`;if(I in this._cache.keys()){const p=this._cache.get(s);this._check(p,i)}else{const p={lower:1/0,upper:-1/0};for(let f=o;f<=_;f++)this._check(this._arr[f],p);this._cache.set(I,p),this._check(p,i)}}return this._cache.set(s,i),i}_check(t,e){t.lower<e.lower&&(e.lower=t.lower),t.upper>e.upper&&(e.upper=t.upper)}}class T{constructor(t){n(this,"_viewData");this._viewData=t}draw(){}drawBackground(t){const e=this._viewData.data;t.useBitmapCoordinateSpace(s=>{const i=s.context;i.scale(s.horizontalPixelRatio,s.verticalPixelRatio),i.strokeStyle=this._viewData.options.lineColor,i.lineWidth=this._viewData.options.lineWidth,i.beginPath();const r=new Path2D,a=new Path2D;r.moveTo(e[0].x,e[0].upper),a.moveTo(e[0].x,e[0].upper);for(const o of e)r.lineTo(o.x,o.upper),a.lineTo(o.x,o.upper);const h=e.length-1;r.lineTo(e[h].x,e[h].lower),a.moveTo(e[h].x,e[h].lower);for(let o=e.length-2;o>=0;o--)r.lineTo(e[o].x,e[o].lower),a.lineTo(e[o].x,e[o].lower);r.lineTo(e[0].x,e[0].upper),r.closePath(),i.stroke(a),i.fillStyle=this._viewData.options.fillColor,i.fill(r)})}}class g{constructor(t){n(this,"_source");n(this,"_data");this._source=t,this._data={data:[],options:this._source._options}}update(){const t=this._source.series,e=this._source.chart.timeScale();this._data.data=this._source._bandsData.map(s=>({x:e.timeToCoordinate(s.time)??-100,upper:t.priceToCoordinate(s.upper)??-100,lower:t.priceToCoordinate(s.lower)??-100}))}renderer(){return new T(this._data)}}function b(c){if(c.close)return c.close;if(c.value)return c.value}const D={lineColor:"rgb(25, 200, 100)",fillColor:"rgba(25, 200, 100, 0.25)",lineWidth:1};class V extends d{constructor(e={}){super();n(this,"_paneViews");n(this,"_seriesData",[]);n(this,"_bandsData",[]);n(this,"_options");n(this,"_timeIndices");n(this,"_upperLower");n(this,"_minValue",Number.POSITIVE_INFINITY);n(this,"_maxValue",Number.NEGATIVE_INFINITY);this._options={...D,...e},this._paneViews=[new g(this)],this._timeIndices=new m([]),this._upperLower=new w([])}updateAllViews(){this._paneViews.forEach(e=>e.update())}paneViews(){return this._paneViews}attached(e){super.attached(e),this.dataUpdated("full")}dataUpdated(e){this._seriesData=x(this.series.data()),this.calculateBands(),e==="full"&&(this._timeIndices=new m(this._seriesData))}calculateBands(){const e=new Array(this._seriesData.length);let s=0;this._minValue=Number.POSITIVE_INFINITY,this._maxValue=Number.NEGATIVE_INFINITY,this._seriesData.forEach(i=>{const r=b(i);if(r===void 0)return;const a=r*1.1,h=r*.9;a>this._maxValue&&(this._maxValue=a),h<this._minValue&&(this._minValue=h),e[s]={upper:a,lower:h,time:i.time},s+=1}),e.length=s,this._bandsData=e,this._upperLower=new w(this._bandsData,4)}autoscaleInfo(e,s){const i=this.chart.timeScale(),r=i.coordinateToTime(i.logicalToCoordinate(e)??0)??0,a=i.coordinateToTime(i.logicalToCoordinate(s)??5e9)??5e9,h=this._timeIndices.findClosestIndex(r,"left"),o=this._timeIndices.findClosestIndex(a,"right"),_=this._upperLower.getMinMax(h,o);return{priceRange:{minValue:_.lower,maxValue:_.upper}}}}l.BandsIndicator=V,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
